<%= javascript_include_tag "OpenLayers" %>

<script type="text/javascript">

// global OpenLayers variables
var map, layer, vlayer, alayer;
// association of annotation ID and feature ID
var feature_annotation = new Array();

// this function implements the DOM manipulation for adding new annotations
function initAnnotation() {
    $("#slideUpBar").hide();
    $(".annotationOverlay").hide();
    
    $("#createNewAnnotation").click(function(){
      $("#annotation_title").attr("value", "");
      $("#annotation_body").attr("value", "");
      $("#slideUpBar").slideDown(function(){
        $("#annotation_title").focus();
      });
    });
    
    $("#buttonCancel").click(function(){
      $("#slideUpBar").slideUp();
    });
    
    $(".annotationClose").click(function(){
      $(this).parents(".annotationOverlay").slideUp();
    });
}

// this function initilalizes the map display with OpenLayers
function initMapView(){
    
    var zoomify_width = <%= @map.width %>;
    var zoomify_height = <%= @map.height %>;
    var zoomify_url = "<%= @map.tileset_url + '/' %>";

    /* The zoomify layer */
    layer = new OpenLayers.Layer.Zoomify( "Zoomify", zoomify_url, 
        new OpenLayers.Size( zoomify_width, zoomify_height ) );
    
    /* The editing controls layer */
    vlayer = new OpenLayers.Layer.Vector( "Editable" );
    vlayer.events.register("featureadded", vlayer, added);
    
    /* The annotation layer */
    alayer = new OpenLayers.Layer.Vector( "Annotations" );
    alayer.events.register("featureselected", vlayer, selected);
    
    /* Display options */
    var options = {
        controls: [], 
        maxExtent: new OpenLayers.Bounds(0, 0, zoomify_width, zoomify_height),
        maxResolution: Math.pow(2, layer.numberOfTiers-1 ),
        numZoomLevels: layer.numberOfTiers,
        units: 'pixels'
    };
    
    map = new OpenLayers.Map("viewer", options);
    
    map.addLayer(layer);
    map.addLayer(vlayer);
    map.addLayer(alayer);
    
    parseWKT();
    
    // map.addControl(new OpenLayers.Control.MousePosition());
    map.addControl(new OpenLayers.Control.PanZoomBar());
    map.addControl(new OpenLayers.Control.MouseDefaults());
    map.addControl(new OpenLayers.Control.KeyboardDefaults());
    
    var select = new OpenLayers.Control.SelectFeature([alayer]);
    map.addControl(select);
    select.activate();
    
    <% if user_signed_in? %>
    map.addControl(new OpenLayers.Control.EditingToolbar(vlayer));
    <% end %>

    map.setBaseLayer(layer);
    map.zoomToMaxExtent();
};

// parses the WKT strings
function parseWKT() {
  var wkt_parser = new OpenLayers.Format.WKT();
  var features = [];
  var bounds;
  
  // iterate over each annotation's WKT data
  // we associate the ID with the feature's ID
  $(".annotationWktData").each(function(){
    var wkt_data = $(this).text();
    var wkt_data_parsed = wkt_parser.read(wkt_data); // wkt_data_parsed is an instance of a OpenLayers.Feature.Vector
    features.push(wkt_data_parsed);
    
    var annotation_id = $(this).parent().parent().attr("id");
    var feature_id = wkt_data_parsed.id;
    feature_annotation[feature_id]  = annotation_id;
  });
  
  alayer.addFeatures(features);
}

// This function is called when a new feature was added to the map
function added(evt) {
    var wkt_data = evt.feature.geometry.toString();
    
    // reinitialize title and body, and copy WKT data
    $("#annotation_title").attr("value", "");
    $("#annotation_body").attr("value", "");
    $("#annotation_wkt_data").attr("value", wkt_data);
    
    // show the popup
    $("#slideUpBar").slideDown(function(){
      $("#annotation_title").focus();
    });
}

// This function is called when an existing feature on the Annotation layer was clicked
function selected(evt) {
    var annotation_id = feature_annotation[evt.feature.id];
    var overlay = $("#" + annotation_id);
    overlay.show();
}

// this function is called when the document is loaded
$(document).ready(function(){
  init();
});

// this function initializes annotation and zoomify code
function init() {
    initAnnotation();
    initMapView();
}


</script>



<h1><%= @map.title %> <small>by <%= link_to @map.user.username, @map.user %></small></h1>

<div id="viewer" border="1pt solid"></div>

<br style="clear:both;">


<div id="mapDetails">
  
  <div class="floatLeft halfSize">  
  
  <p>This map was uploaded <%= time_ago_in_words @map.creation_date %> ago, last edited <%= time_ago_in_words @map.edit_date %> ago.</p>
  
  <% unless @map.description.empty? %>
    <blockquote>
      <%=  @map.description %>
    </blockquote>
  <% end %>
  
  </div>
  
  <div class="floatRight tools">  
      <%= render :partial => "users/badge", :locals => { :user => @map.user } %>
      <br style="clear:both;">
      <% if current_user == @map.user %>
      <%= link_to 'Edit this map', edit_map_path(@map) %><br>
      <%= link_to 'Delete', map_path(@map), :method => :delete, :confirm => "Are you sure you want to delete this map?" %>
      <% end %>
  </div>
  
</div>  


<br style="clear:both;">

<hr>

<div id="annotations" class="halfSize floatLeft">
  <h2>Annotations <small><%= link_to "(Show all...)", map_annotations_path(@map) %></small></h2>
  <ul id="annotationList">
    <% for annotation in @map.annotations.order("edit_date").reverse %>
      <li><%= link_to annotation.title, annotation %>, by <%= link_to annotation.user.username, annotation.user %>, <%= time_ago_in_words(annotation.edit_date) %> ago</li>
    <% end %>
  </ul>
</div>

<div id="hiddenAnnotations">
  <% for annotation in @map.annotations.order("edit_date") %>
    <div class="annotationOverlay" id="<%= annotation.id %>">
      <div class="annotationOverlayContent">
        <small style="float:right;"><a class="annotationClose">Close</a></small>
        <div class="annotationTitle"><%= link_to annotation.title, annotation, :target => :blank %></div>
        <div class="annotationBody"><%= annotation.body %></div>
        <div class="annotationWktData hiddenElement"><%= annotation.wkt_data %></div>
      </div>
    </div>
  <% end %>
</div>

<br style="clear:both;">

<div id="slideUpBar">
  <div id="slideUpBarContent">
    <div class="floatRight">
      <h2>Add a new Annotation ... </h2>
      <p>
        What do you want to annotate about the area you marked?
      </p>
      <p>
        Please enter a short, descriptive title and a body for your new Annotation. When you're done, click "Add Annotation".
        
      </p>
    </div>
    <%= form_for([@map, Annotation.new], :remote => true, :class => 'floatLeft' ) do |f| %>
        <p>
          <%= f.label :title %><br/>
          <%= f.text_field :title, :size => 55 %>
        </p>
        <p>
          <%= f.label :body %><br/>
          <%= f.text_area :body, :cols => 40, :rows => 5 %>
        </p>
        <input type="button" value="Cancel" id="buttonCancel" onclick="confirm('Are you sure you want to cancel adding an annotation?');"/>
        <%= f.submit "Add Annotation" %>
        <%= f.text_field :wkt_data, :hidden => true %>
    <% end %>
    </div>
  </div>
</div>

