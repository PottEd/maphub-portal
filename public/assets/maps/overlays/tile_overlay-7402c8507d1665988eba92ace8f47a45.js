/**
 * An overlay layer that consists of image tiles.
 * 
 * Loosely based on Gavin Harriss' TileOverlay (http://www.gavinharriss.com/)
 * 
 * @param {Object} parameters Configuration parameters. Required parameters are:
 *   map: The maphub.Map instance on which this overlay will exist.
 *   tileSize: The google.maps.Size of the tiles on which this overlay is based.
 */
maphub.TileOverlay=function(e){this.tiles={};if(e){this.map=e.map,this.tileSize=e.tileSize,this.url=e.overlay_tileset_uri;var t=this;this.map.deleteHiddenTiles&&google.maps.event.addListener(this.map.googleMap,"idle",function(){t.deleteHiddenTiles()})}},maphub.TileOverlay.prototype.deleteHiddenTiles=function(){var e=this.map.googleMap.getBounds(),t=this.map.googleMap.getZoom(),n=e.getNorthEast(),r=e.getSouthWest(),i=this.latLngToTile(n,t),s=this.latLngToTile(r,t),o=new google.maps.Point(s.x,i.y),u=new google.maps.Point(i.x,s.y),a=s.x,f=i.x,l=s.y,c=i.y,h={};for(var p in this.tiles)for(var d=a;d<=f;d++)for(var v=c;v<=l;v++){var m=t+"-"+d+"-"+v;m==p&&(h[p]=this.tiles[p])}this.tiles=h;return},maphub.TileOverlay.prototype.getTile=function(e,t,n){var r=t+"-"+e.x+"-"+e.y,i=null;if(typeof this.tiles[r]=="undefined"){var s=this.getTileUrlCoord(e,t);i=n.createElement("div"),i.style.width=this.tileSize.width+"px",i.style.height=this.tileSize.height+"px",i.style.background="url("+this.url+"/"+t+"/"+s.x+"/"+s.y+".png) no-repeat",this.tiles[r]=i}else console.log("Found existing tile for "+r),i=this.tiles[r];return i},maphub.TileOverlay.prototype.latLngToTile=function(e,t){var n=this.map.googleMap.getProjection(),r=n.fromLatLngToPoint(e),i=new google.maps.Point(r.x*Math.pow(2,t),r.y*Math.pow(2,t)),s=new google.maps.Point(Math.floor(i.x/this.tileSize.width),Math.floor(i.y/this.tileSize.height));return s},maphub.TileOverlay.prototype.getTileUrlCoordFromLatLng=function(e,t){return this.getTileUrlCoord(this.latLngToTile(e,t),t)},maphub.TileOverlay.prototype.getTileUrlCoord=function(e,t){var n=1<<t,r=n-e.y-1,i=e.x;if(i<0||i>=n)i=(i%n+n)%n;return new google.maps.Point(i,r)},maphub.TileOverlay.prototype.toString=function(){return"TileOverlay<map="+this.map+", tileSize="+this.tileSize+">"};