function removeTooltips(){$.each(window.annotation_view.tooltips,function(){this.hide()})}maphub.AnnotationView=function(e){function t(e){var t=e.feature.geometry.CLASS_NAME;e.feature.tooltip||(t=="OpenLayers.Geometry.Point"?e.feature.tooltip=new maphub.ControlPointTooltip(e.feature.control_point,p.user_id):e.feature.tooltip=new maphub.AnnotationTooltip(e.feature.annotation,p.user_id),p.tooltips.push(e.feature.tooltip));var n=e.feature.geometry.getBounds().getCenterLonLat(),r=this.map.getPixelFromLonLat(n);r.x<0&&(r.x=0),e.feature.tooltip.show(r.x,r.y)}function n(e){e.feature.tooltip.hide()}function r(e){p.keyboard_shortcuts.deactivate();for(var t in p.tooltips)p.tooltips[t].hide();var n=e.feature.geometry.CLASS_NAME;n=="OpenLayers.Geometry.Point"?s(e):i(e)}function i(e){var t=e.feature.geometry.toString();$("#annotation_body").attr("value","Add your annotation here!"),$("#annotation_wkt_data").attr("value",t),$("#annotation_boundary_attributes_ne_x").attr("value",e.feature.geometry.bounds.right),$("#annotation_boundary_attributes_ne_y").attr("value",e.feature.geometry.bounds.top),$("#annotation_boundary_attributes_sw_x").attr("value",e.feature.geometry.bounds.left),$("#annotation_boundary_attributes_sw_y").attr("value",e.feature.geometry.bounds.bottom),$("#modal-annotation-tags").empty(),$("#tagging-help").hide(),$("#no-tags").show(),$("#annotation-submit-button").removeAttr("disabled"),$("#modal-annotation").modal({backdrop:"static",keyboard:!1}),$("#annotation_body").focus(),$("#annotation_body").select()}function s(e){var t=e.feature.geometry.toString();$("#control_point_wkt_data").attr("value",t),$("#control_point_x").attr("value",e.feature.geometry.x),$("#control_point_y").attr("value",e.feature.geometry.y),$("#place-search").attr("value",""),$("#modal-control-point").modal({backdrop:"static",keyboard:!1}),$("#place-search").focus()}this.zoomify_width=e.width,this.zoomify_height=e.height,this.zoomify_url=e.zoomify_url,this.annotations_url=e.annotations_url,this.control_points_url=e.control_points_url,this.editable=e.editable,this.user_id=e.user_id,this.features_annotations=[],this.features_annotations_own=[],this.features_control_points=[],this.annotations=[],this.control_points=[],this.tooltips=[];var o=new OpenLayers.StyleMap({"default":new OpenLayers.Style({strokeColor:"#cc4400",fillOpacity:"0.4",fillColor:"#cc4400",cursor:"pointer"}),select:new OpenLayers.Style({strokeColor:"#005580",fillColor:"#00A9FF",fillOpacity:"0.4"})}),u=new OpenLayers.Style({externalGraphic:"/assets/pin.png",graphicWidth:"15",graphicWidth:"25",graphicXOffset:-13,graphicYOffset:-25,cursor:"pointer"}),a=new OpenLayers.StyleMap({"default":u,select:u,temporary:u});this.baseLayer=new OpenLayers.Layer.Zoomify("Zoomify",this.zoomify_url,new OpenLayers.Size(this.zoomify_width,this.zoomify_height),{displayInLayerSwitcher:!1}),this.editLayer=new OpenLayers.Layer.Vector("Editable",{styleMap:o,displayInLayerSwitcher:!1}),this.editLayer.events.register("featureadded",this.editLayer,r),this.controlPointEditLayer=new OpenLayers.Layer.Vector("Control Point Editable",{styleMap:a,displayInLayerSwitcher:!1}),this.controlPointEditLayer.events.register("featureadded",this.controlPointEditLayer,r),$("a.close").click(function(){p.editLayer.removeAllFeatures(),p.controlPointEditLayer.removeAllFeatures()}),this.annotationLayer=new OpenLayers.Layer.Vector("Annotations created by others",{styleMap:o}),this.annotationLayerOwn=new OpenLayers.Layer.Vector("Annotations created by me",{styleMap:o}),this.controlPointsLayer=new OpenLayers.Layer.Vector("Control Points",{styleMap:a});var f=new OpenLayers.Bounds(0,0,this.zoomify_width,this.zoomify_height),l={controls:[],maxExtent:f,restrictedExtent:f,maxResolution:Math.pow(2,this.baseLayer.numberOfTiers-1),numZoomLevels:this.baseLayer.numberOfTiers,units:"pixels",theme:"/assets/theme/default/style.css"};this.map=new OpenLayers.Map("viewer",l),this.map.addLayer(this.baseLayer),this.map.addLayer(this.editLayer),this.map.addLayer(this.controlPointEditLayer),this.map.addLayer(this.annotationLayer),this.editable&&this.map.addLayer(this.annotationLayerOwn),this.map.addLayer(this.controlPointsLayer),this.remoteLoadAnnotations(),this.remoteLoadControlPoints(),this.initAutoComplete(),this.map.addControl(new OpenLayers.Control.Navigation),this.map.addControl(new OpenLayers.Control.MousePosition),this.map.addControl(new OpenLayers.Control.PanZoomBar),this.keyboard_shortcuts=new OpenLayers.Control.KeyboardDefaults,this.map.addControl(this.keyboard_shortcuts),this.map.addControl(new OpenLayers.Control.LayerSwitcher({div:OpenLayers.Util.getElement("layerswitcher")}));var c=new OpenLayers.Control.SelectFeature([this.annotationLayer,this.annotationLayerOwn,this.controlPointsLayer],{renderIntent:"select",toggle:!0});this.map.addControl(c),c.activate(),this.annotationLayer.events.on({featureselected:t,featureunselected:n}),this.annotationLayerOwn.events.on({featureselected:t,featureunselected:n}),this.controlPointsLayer.events.on({featureselected:t,featureunselected:n});if(this.editable){this.drawControls={point:new OpenLayers.Control.DrawFeature(this.controlPointEditLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(this.editLayer,OpenLayers.Handler.Path),polygon:new OpenLayers.Control.DrawFeature(this.editLayer,OpenLayers.Handler.Polygon),box:new OpenLayers.Control.DrawFeature(this.editLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:!0}})};for(var h in this.drawControls)this.map.addControl(this.drawControls[h]);$("#control-toggle-annotation-types").hide(),$("#control-toggle-annotation").click(function(){$("#control-toggle-annotation-types").slideDown()}),$("#control-toggle-control-point, #control-toggle-navigate").click(function(){$("#control-toggle-annotation-types").slideUp()});var p=this;$("#control-toggle button").click(function(){for(h in p.drawControls){var e=p.drawControls[h];this.value==h?e.activate():e.deactivate()}})}this.map.setBaseLayer(this.baseLayer),this.map.zoomToMaxExtent();var p=this},maphub.AnnotationView.prototype.initAutoComplete=function(){$("input#place-search").autocomplete({source:function(e,t){$.ajax({url:"http://ws.geonames.org/searchJSON",dataType:"jsonp",data:{featureClass:"P",style:"full",maxRows:12,name_startsWith:e.term},success:function(e){t($.map(e.geonames,function(e){return{label:e.name+(e.adminName1?", "+e.adminName1:"")+", "+e.countryName,value:e.name,short_name:e.name,lat:e.lat,lng:e.lng,geonameId:e.geonameId}}))}})},minLength:2,select:function(e,t){$("#control_point_name").attr("value",t.item.short_name),$("#control_point_geonames_label").attr("value",t.item.label),$("#control_point_lat").attr("value",t.item.lat),$("#control_point_lng").attr("value",t.item.lng),$("#control_point_geonames_id").attr("value",t.item.geonameId)},open:function(){$(this).removeClass("ui-corner-all").addClass("ui-corner-top")},close:function(){$(this).removeClass("ui-corner-top").addClass("ui-corner-all")}})},maphub.AnnotationView.prototype.remoteLoadAnnotations=function(){var e=new OpenLayers.Format.WKT,t=this;$.getJSON(this.annotations_url,function(n){$.each(n,function(n,r){var i=e.read(r.wkt_data);i.annotation=r,i.annotation.user_id==t.user_id?t.features_annotations_own.push(i):t.features_annotations.push(i),t.annotations.push(r)}),t.annotationLayer.addFeatures(t.features_annotations),t.annotationLayerOwn.addFeatures(t.features_annotations_own)})},maphub.AnnotationView.prototype.remoteLoadControlPoints=function(){var e=new OpenLayers.Format.WKT,t=this;$.getJSON(this.control_points_url,function(n){$.each(n,function(n,r){var i=e.read(r.wkt_data);i.control_point=r,t.features_control_points.push(i),t.control_points.push(r)}),t.controlPointsLayer.addFeatures(t.features_control_points)})};